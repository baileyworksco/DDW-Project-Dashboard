<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management KPI Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .connection-status {
            margin-top: 15px;
            padding: 12px;
            background: #c6f6d5;
            border-left: 4px solid #48bb78;
            border-radius: 6px;
            font-size: 14px;
            color: #22543d;
        }

        .connection-status.loading {
            background: #feebc8;
            border-left-color: #ed8936;
            color: #7c2d12;
        }

        .date-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }

        .date-filter select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .kpi-label {
            font-size: 13px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .kpi-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kpi-change.positive {
            color: #48bb78;
        }

        .kpi-change.negative {
            color: #f56565;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .task-list {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-name {
            font-weight: 500;
            color: #2d3748;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 13px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-on-track {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-at-risk {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-delayed {
            background: #feebc8;
            color: #7c2d12;
        }

        .task-management {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .task-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .task-filters input,
        .task-filters select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .task-filters input {
            flex: 1;
            min-width: 200px;
        }

        .task-filters button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
        }

        .task-filters button:hover {
            background: #5568d3;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
        }

        .task-table th {
            text-align: left;
            padding: 12px;
            background: #f7fafc;
            color: #718096;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        .task-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .task-table tr:hover {
            background: #f7fafc;
        }

        .priority-high {
            color: #f56565;
            font-weight: 600;
        }

        .priority-medium {
            color: #ed8936;
            font-weight: 600;
        }

        .priority-low {
            color: #48bb78;
            font-weight: 600;
        }

        .assignee-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .action-btn:hover {
            background: #f7fafc;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            padding: 10px 20px;
            background: white;
            color: #4a5568;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: #f7fafc;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Project Management Dashboard</h1>
            <p>Real-time overview of team performance and project health</p>
            <div class="connection-status loading" id="connection-status">
                üîÑ Connecting to Google Sheets...
            </div>
            <div class="date-filter">
                <label for="period">Period:</label>
                <select id="period" onchange="updateDashboard()">
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">On-Time Delivery Rate</div>
                <div class="kpi-value" id="delivery-rate">87%</div>
                <div class="kpi-change positive">
                    <span>‚Üë 5% from last period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Active Projects</div>
                <div class="kpi-value" id="active-projects">12</div>
                <div class="kpi-change">
                    <span>3 completed this period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Team Utilization</div>
                <div class="kpi-value" id="utilization">78%</div>
                <div class="kpi-change negative">
                    <span>‚Üì 3% from last period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Budget Variance</div>
                <div class="kpi-value" id="budget-variance">-2.4%</div>
                <div class="kpi-change positive">
                    <span>Under budget</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Tasks Completed</div>
                <div class="kpi-value" id="tasks-completed">156</div>
                <div class="kpi-change positive">
                    <span>‚Üë 12% from last period</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Average Cycle Time</div>
                <div class="kpi-value" id="cycle-time">3.2d</div>
                <div class="kpi-change positive">
                    <span>‚Üì 0.5d faster</span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Project Status Distribution</div>
                <canvas id="statusChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-title">Task Completion Trend</div>
                <canvas id="trendChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-title">Budget vs Actual Spending</div>
                <canvas id="budgetChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-title">Team Velocity</div>
                <canvas id="velocityChart"></canvas>
            </div>
        </div>

        <div class="task-management">
            <div class="chart-title">Task Management</div>
            <div class="task-filters">
                <input type="text" id="search-tasks" placeholder="Search tasks..." onkeyup="filterTasks()">
                <select id="filter-project" onchange="filterTasks()">
                    <option value="">All Projects</option>
                    <option value="Website Redesign">Website Redesign</option>
                    <option value="Mobile App">Mobile App</option>
                    <option value="API Integration">API Integration</option>
                    <option value="Database Migration">Database Migration</option>
                    <option value="Security Audit">Security Audit</option>
                </select>
                <select id="filter-status" onchange="filterTasks()">
                    <option value="">All Status</option>
                    <option value="To Do">To Do</option>
                    <option value="In Progress">In Progress</option>
                    <option value="In Review">In Review</option>
                    <option value="Completed">Completed</option>
                </select>
                <select id="filter-assignee" onchange="filterTasks()">
                    <option value="">All Assignees</option>
                    <option value="Sarah Chen">Sarah Chen</option>
                    <option value="Mike Johnson">Mike Johnson</option>
                    <option value="Emma Davis">Emma Davis</option>
                    <option value="James Wilson">James Wilson</option>
                </select>
                <button onclick="openAddTaskModal()">+ Add Task</button>
            </div>

            <table class="task-table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Project</th>
                        <th>Assignee</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Due Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="task-table-body">
                    <!-- Tasks will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="task-list">
            <div class="chart-title">Active Projects Overview</div>
            <div id="project-list">
                <div class="task-item">
                    <div class="task-name">Website Redesign</div>
                    <div class="task-meta">
                        <span class="status-badge status-on-track">On Track</span>
                        <span>Progress: 65%</span>
                        <span>Due: Feb 15</span>
                    </div>
                </div>
                <div class="task-item">
                    <div class="task-name">Mobile App Development</div>
                    <div class="task-meta">
                        <span class="status-badge status-at-risk">At Risk</span>
                        <span>Progress: 42%</span>
                        <span>Due: Feb 28</span>
                    </div>
                </div>
                <div class="task-item">
                    <div class="task-name">API Integration</div>
                    <div class="task-meta">
                        <span class="status-badge status-on-track">On Track</span>
                        <span>Progress: 88%</span>
                        <span>Due: Feb 10</span>
                    </div>
                </div>
                <div class="task-item">
                    <div class="task-name">Database Migration</div>
                    <div class="task-meta">
                        <span class="status-badge status-delayed">Delayed</span>
                        <span>Progress: 35%</span>
                        <span>Due: Feb 5</span>
                    </div>
                </div>
                <div class="task-item">
                    <div class="task-name">Security Audit</div>
                    <div class="task-meta">
                        <span class="status-badge status-on-track">On Track</span>
                        <span>Progress: 72%</span>
                        <span>Due: Feb 20</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Add New Task</div>
            <form id="taskForm">
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="taskName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="taskDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="taskProject" required>
                        <option value="">Select Project</option>
                        <option value="Website Redesign">Website Redesign</option>
                        <option value="Mobile App">Mobile App Development</option>
                        <option value="API Integration">API Integration</option>
                        <option value="Database Migration">Database Migration</option>
                        <option value="Security Audit">Security Audit</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Assignee</label>
                    <select id="taskAssignee" required>
                        <option value="">Select Assignee</option>
                        <option value="Sarah Chen">Sarah Chen</option>
                        <option value="Mike Johnson">Mike Johnson</option>
                        <option value="Emma Davis">Emma Davis</option>
                        <option value="James Wilson">James Wilson</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="taskPriority" required>
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="taskStatus" required>
                        <option value="To Do" selected>To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="In Review">In Review</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Progress (%)</label>
                    <input type="number" id="taskProgress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>Due Date</label>
                    <input type="date" id="taskDueDate" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeTaskModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const SHEET_ID = '1lou_AzFx8hpXsbm8zrlECTHYyY9APNkGRY8Wq36sYbU';
        
        // Fetch data from published Google Sheets
        async function fetchSheetData() {
            try {
                const sheetsData = {
                    projects: [],
                    tasks: [],
                    team: []
                };
                
                // For published sheets, we need to get the GID (sheet ID) for each tab
                // We'll try common GIDs and the sheet names
                const sheetsConfig = [
                    { name: 'Projects', key: 'projects', gid: '0' },
                    { name: 'Tasks', key: 'tasks', gid: '1' },
                    { name: 'Team Members', key: 'team', gid: '2' }
                ];
                
                for (const sheet of sheetsConfig) {
                    try {
                        // Published sheets work with this format
                        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${sheet.gid}`;
                        
                        console.log(`Fetching ${sheet.name}...`);
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            console.log(`Failed to fetch ${sheet.name}, trying alternative method...`);
                            continue;
                        }
                        
                        const csv = await response.text();
                        const data = parseCSV(csv);
                        
                        if (data && data.length > 0) {
                            sheetsData[sheet.key] = data;
                            console.log(`‚úì Loaded ${sheet.name}: ${data.length} rows`);
                        }
                    } catch (sheetError) {
                        console.error(`Error loading ${sheet.name}:`, sheetError);
                    }
                }
                
                // Check if we got any data
                if (sheetsData.projects.length > 0 || sheetsData.tasks.length > 0) {
                    console.log('‚úì Successfully loaded data from Google Sheets');
                    return sheetsData;
                }
                
                console.log('No data loaded - trying fallback method...');
                
                // Fallback: try to load just the first sheet
                const fallbackUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
                const fallbackResponse = await fetch(fallbackUrl);
                if (fallbackResponse.ok) {
                    const csv = await fallbackResponse.text();
                    sheetsData.projects = parseCSV(csv);
                    console.log('‚úì Loaded data from first sheet');
                    return sheetsData;
                }
                
                throw new Error('Could not load data from any sheet');
                
            } catch (error) {
                console.error('Error fetching sheet data:', error);
                console.log('%c‚ö†Ô∏è TROUBLESHOOTING:', 'font-weight: bold; font-size: 14px; color: #ed8936;');
                console.log('The sheet is published, but there may be a browser security issue.');
                console.log('');
                console.log('Quick fixes:');
                console.log('1. Upload this HTML file to Google Drive and open it from there, OR');
                console.log('2. Run a local web server (see instructions in the message)');
                console.log('');
                console.log('%cUsing sample data for now so you can see how it works.', 'font-style: italic;');
                return null;
            }
        }
        
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const result = [];
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const obj = {};
                const currentLine = lines[i].split(',');
                
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentLine[j] ? currentLine[j].replace(/"/g, '').trim() : '';
                }
                result.push(obj);
            }
            return result;
        }
        
        function updateDashboardFromSheet(sheetsData) {
            if (!sheetsData) return;
            
            // Update KPIs from Google Sheets data
            const projects = sheetsData.projects;
            const tasksData = sheetsData.tasks;
            
            // Calculate active projects
            const activeProjects = projects.filter(p => 
                p.Status === 'In Progress' || p.Status === 'At Risk' || p.Status === 'On Track'
            ).length;
            document.getElementById('active-projects').textContent = activeProjects;
            
            // Calculate on-time delivery
            const completedOnTime = projects.filter(p => p.Status === 'Completed').length;
            const totalCompleted = projects.filter(p => p.Status === 'Completed').length + 3; // Sample adjustment
            const deliveryRate = Math.round((completedOnTime / totalCompleted) * 100);
            document.getElementById('delivery-rate').textContent = deliveryRate + '%';
            
            // Calculate tasks completed
            const completedTasks = tasksData.filter(t => t.Status === 'Completed').length;
            document.getElementById('tasks-completed').textContent = completedTasks * 20; // Scale for display
            
            // Update project list
            updateProjectsList(projects);
            
            // Update task management table
            updateTasksFromSheet(tasksData);
        }
        
        function updateProjectsList(projects) {
            const projectList = document.getElementById('project-list');
            projectList.innerHTML = '';
            
            projects.slice(0, 5).forEach(project => {
                const statusClass = project.Status.toLowerCase().replace(' ', '-');
                const progress = project['Overall Progress (%)'] || '0%';
                const progressNum = parseInt(progress) || 0;
                
                const projectItem = document.createElement('div');
                projectItem.className = 'task-item';
                projectItem.innerHTML = `
                    <div class="task-name">${project['Project Name']}</div>
                    <div class="task-meta">
                        <span class="status-badge status-${statusClass}">${project.Status}</span>
                        <span>Progress: ${progressNum}%</span>
                        <span>Due: ${formatSheetDate(project['End Date'])}</span>
                    </div>
                `;
                projectList.appendChild(projectItem);
            });
        }
        
        function updateTasksFromSheet(tasksData) {
            // Convert Google Sheets data to tasks array format
            tasks = tasksData.map((task, index) => ({
                id: index + 1,
                name: task['Task Name'] || '',
                project: task['Project ID'] || '',
                assignee: task['Assigned To'] || '',
                priority: task.Priority || 'Medium',
                status: task.Status || 'To Do',
                progress: parseFloat(task['Progress (%)']) || 0,
                dueDate: task['Due Date'] || new Date().toISOString().split('T')[0]
            }));
            
            renderTasks();
        }
        
        function formatSheetDate(dateStr) {
            if (!dateStr) return 'TBD';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        // Load data on page load
        let initialLoadComplete = false;
        fetchSheetData().then(sheetsData => {
            const statusEl = document.getElementById('connection-status');
            if (sheetsData) {
                updateDashboardFromSheet(sheetsData);
                initialLoadComplete = true;
                statusEl.className = 'connection-status';
                statusEl.innerHTML = '‚úì Connected to Google Sheets - Auto-refreshing every 5 minutes | Last updated: ' + new Date().toLocaleTimeString();
                console.log('‚úì Dashboard connected to Google Sheets!');
            } else {
                statusEl.className = 'connection-status loading';
                statusEl.innerHTML = `
                    ‚ö†Ô∏è Sheet is published but browser security is blocking the connection. 
                    <strong>Quick fix:</strong> Upload this HTML file to Google Drive and open it from there (no server needed!). 
                    Using sample data for now so you can see how it works.
                `;
                console.log('%cüìã SEE CONSOLE ABOVE FOR DETAILED INSTRUCTIONS', 'background: #feebc8; padding: 10px; font-weight: bold;');
            }
        });
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
            fetchSheetData().then(sheetsData => {
                if (sheetsData) updateDashboardFromSheet(sheetsData);
            });
        }, 300000);

        // Project Status Distribution Chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['On Track', 'At Risk', 'Delayed', 'Completed'],
                datasets: [{
                    data: [6, 2, 1, 3],
                    backgroundColor: ['#48bb78', '#f56565', '#ed8936', '#4299e1'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Task Completion Trend Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Tasks Completed',
                    data: [32, 45, 38, 41],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Budget vs Actual Chart
        const budgetCtx = document.getElementById('budgetChart').getContext('2d');
        new Chart(budgetCtx, {
            type: 'bar',
            data: {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                datasets: [{
                    label: 'Budgeted',
                    data: [50000, 55000, 52000, 58000],
                    backgroundColor: '#cbd5e0'
                }, {
                    label: 'Actual',
                    data: [48500, 53200, 51000, 56800],
                    backgroundColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Team Velocity Chart
        const velocityCtx = document.getElementById('velocityChart').getContext('2d');
        new Chart(velocityCtx, {
            type: 'line',
            data: {
                labels: ['Sprint 1', 'Sprint 2', 'Sprint 3', 'Sprint 4', 'Sprint 5', 'Sprint 6'],
                datasets: [{
                    label: 'Story Points',
                    data: [45, 52, 48, 55, 58, 62],
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        function updateDashboard() {
            // Refresh data from Google Sheets when period changes
            fetchSheetData().then(sheetsData => {
                if (sheetsData) {
                    updateDashboardFromSheet(sheetsData);
                }
            });
            console.log('Dashboard updated for period:', document.getElementById('period').value);
        }

        // Task Management System
        let tasks = [
            {
                id: 1,
                name: 'Design homepage mockups',
                project: 'Website Redesign',
                assignee: 'Sarah Chen',
                priority: 'High',
                status: 'In Progress',
                progress: 75,
                dueDate: '2026-02-08'
            },
            {
                id: 2,
                name: 'Implement user authentication',
                project: 'Mobile App',
                assignee: 'Mike Johnson',
                priority: 'High',
                status: 'In Progress',
                progress: 60,
                dueDate: '2026-02-12'
            },
            {
                id: 3,
                name: 'Create REST API endpoints',
                project: 'API Integration',
                assignee: 'Emma Davis',
                priority: 'Medium',
                status: 'In Progress',
                progress: 90,
                dueDate: '2026-02-10'
            },
            {
                id: 4,
                name: 'Database schema migration',
                project: 'Database Migration',
                assignee: 'James Wilson',
                priority: 'High',
                status: 'To Do',
                progress: 20,
                dueDate: '2026-02-05'
            },
            {
                id: 5,
                name: 'Conduct penetration testing',
                project: 'Security Audit',
                assignee: 'Sarah Chen',
                priority: 'High',
                status: 'In Review',
                progress: 85,
                dueDate: '2026-02-18'
            },
            {
                id: 6,
                name: 'Update navigation menu',
                project: 'Website Redesign',
                assignee: 'Emma Davis',
                priority: 'Medium',
                status: 'To Do',
                progress: 0,
                dueDate: '2026-02-14'
            },
            {
                id: 7,
                name: 'Implement push notifications',
                project: 'Mobile App',
                assignee: 'Mike Johnson',
                priority: 'Low',
                status: 'To Do',
                progress: 0,
                dueDate: '2026-02-25'
            },
            {
                id: 8,
                name: 'Write API documentation',
                project: 'API Integration',
                assignee: 'James Wilson',
                priority: 'Medium',
                status: 'Completed',
                progress: 100,
                dueDate: '2026-02-01'
            }
        ];

        let editingTaskId = null;

        function renderTasks() {
            const tbody = document.getElementById('task-table-body');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('search-tasks').value.toLowerCase();
            const projectFilter = document.getElementById('filter-project').value;
            const statusFilter = document.getElementById('filter-status').value;
            const assigneeFilter = document.getElementById('filter-assignee').value;

            const filteredTasks = tasks.filter(task => {
                const matchesSearch = task.name.toLowerCase().includes(searchTerm);
                const matchesProject = !projectFilter || task.project === projectFilter;
                const matchesStatus = !statusFilter || task.status === statusFilter;
                const matchesAssignee = !assigneeFilter || task.assignee === assigneeFilter;
                return matchesSearch && matchesProject && matchesStatus && matchesAssignee;
            });

            filteredTasks.forEach(task => {
                const row = document.createElement('tr');
                const initials = task.assignee.split(' ').map(n => n[0]).join('');
                const priorityClass = `priority-${task.priority.toLowerCase()}`;
                
                row.innerHTML = `
                    <td><strong>${task.name}</strong></td>
                    <td>${task.project}</td>
                    <td>
                        <div class="assignee-avatar" title="${task.assignee}">${initials}</div>
                    </td>
                    <td><span class="${priorityClass}">${task.priority}</span></td>
                    <td><span class="status-badge status-${task.status.toLowerCase().replace(' ', '-')}">${task.status}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <small>${task.progress}%</small>
                    </td>
                    <td>${formatDate(task.dueDate)}</td>
                    <td>
                        <button class="action-btn" onclick="editTask(${task.id})">Edit</button>
                        <button class="action-btn" onclick="deleteTask(${task.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function filterTasks() {
            renderTasks();
        }

        function openAddTaskModal() {
            editingTaskId = null;
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('taskForm').reset();
            document.getElementById('taskModal').classList.add('active');
        }

        function editTask(taskId) {
            editingTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskProject').value = task.project;
            document.getElementById('taskAssignee').value = task.assignee;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskProgress').value = task.progress;
            document.getElementById('taskDueDate').value = task.dueDate;
            document.getElementById('taskModal').classList.add('active');
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                renderTasks();
            }
        }

        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            editingTaskId = null;
        }

        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const taskData = {
                name: document.getElementById('taskName').value,
                project: document.getElementById('taskProject').value,
                assignee: document.getElementById('taskAssignee').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                progress: parseInt(document.getElementById('taskProgress').value),
                dueDate: document.getElementById('taskDueDate').value
            };

            if (editingTaskId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
            } else {
                // Add new task
                const newTask = {
                    id: Math.max(...tasks.map(t => t.id)) + 1,
                    ...taskData
                };
                tasks.push(newTask);
            }

            renderTasks();
            closeTaskModal();
        });

        // Close modal when clicking outside
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTaskModal();
            }
        });

        // Initialize tasks on page load
        renderTasks();
    </script>
</body>
</html>
